#!/bin/sh

# TODO: print usage
# TODO: use options like `--exclude-dirs` instead of one arg array

LISTEN_DIR=$1
shift
EXCLUDE="$1"
shift

for i in "$@"; do
    EXCLUDE="$EXCLUDE,$i"
done

EXCLUDE_ROOT=$(echo $LISTEN_DIR | 
    awk -F '/' '{ gsub("\\.", "\\.", $3); print $3 }')
EXCLUDE=$(echo $EXCLUDE | 
    sed 's/,/)|(/g; s/^/(/g; s/$/)/g; s/\(\w\)\()\)/\1\/.*\2/g')

#echo -e "\nEXCLUDE_ROOT: $EXCLUDE_ROOT" # uncomment to echo pattern root

while LINE=$(inotifywait -qr -e moved_to -e create \
--exclude "/$EXCLUDE_ROOT/.*/($EXCLUDE|(\.|new|cur))" \
--format %w%f $LISTEN_DIR)
do
    #echo $LINE # uncomment to show path of triggered event
    parsemail-exec "$LINE" "$(which notify-newmail)"
done
